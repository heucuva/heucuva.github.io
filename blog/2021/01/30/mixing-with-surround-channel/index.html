
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.7">
    
    
      
        <title>Mixing with Surround Channel - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#4cae4f">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../../../stylesheets/dark_theme.css">
    
      <link rel="stylesheet" href="../../../../../stylesheets/codehilite.css">
    
      <link rel="stylesheet" href="../../../../../stylesheets/dark_theme-admonition.css">
    
      <link rel="stylesheet" href="../../../../../stylesheets/pymdownx-highlight.css">
    
    
      
    
    
<meta name="theme-color" content="#212121">

<link rel='icon' href='/assets/images/favicon.ico'>

<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='mobile-web-app-capable' content='yes'>
<link rel="manifest" href="/manifest.json">

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="green" data-md-color-accent="light-green">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../../../../.." title="My Docs" class="md-header-nav__button md-logo" aria-label="My Docs">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Mixing with Surround Channel
            
          </span>
        </div>
      </div>
    </div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
      
      <label class="md-nav__link" for="nav-3">
        Blog
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Blog" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../31/panning-calculations/" class="md-nav__link">
        Panning Calculations (01/31/20)
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Mixing with Surround Channel (01/30/20)
      </a>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Mixing with Surround Channel (01/30/20)</h1>
                
                <p>While building my tracked music player that's written in Go, <a href="https://github.com/gotracker/gotracker">Gotracker</a>, I noticed that a few formats referred to Surround Sound (specifically, Dolby Pro Logic II). I remember researching how to achieve Pro Logic surround sound encoding a few decades ago, but I didn't recall how to achieve it in source code. Apparently, it's really simple - like, extremely so... or so the Internet would have you believe at first glance.</p>
<p>When you go to do your final mix before heading the audio data out to the sound device, you take your surround channel and mix it into the left channel with a +90&deg; phase and the right channel with a -90&deg; phase. However, it's not exactly as simple as that.</p>
<p>Here's the full process, in brief:
1. The Surround channel is a monaural channel that does not link to any other channels via positional variation - cross-fading with the surround channel might not do what you expect.
2. Before it heads into the bandpass filter in step 3, it needs a -3dB attenuation.
3. A bandpass filter is applied that excludes frequences outside the range between 100Hz and 7000Hz, inclusively.
4. A Dolby <code>B-type</code> noise reduction (or compatible, such as dbx) filter is applied.
5. The result of step 4 is split into two channels, a left at +90&deg; phase shift and a right at -90&deg; phase shift.
6. The final mix occurs with the result of step 5.</p>
<p>In order to be 100% compatible with Pro Logic II, step 4 can't be bypassed. It reduces the fidelity of the audio pretty badly, but it's a fact of dealing with decades-old hardware, I suppose. However, modern implementations of Pro Logic (III and newer) seem to be pretty lenient about how to detect the surround channel out of the left+right channels, so you can probably get by with not implementing the B-type NR and only sometimes get bleed-through of surround audio in the left/right forward channels.</p>
<p>In the process of researching how to write my own, I came across some code that <a href="mailto:derek.john.evans@hotmail.com">Derek J. Evans</a> wrote for a Reaper JS plugin that takes a quad-channel output and generates a Pro Logic II-compatible downmix to stereo - seems pretty much right on the money for my needs:</p>
<p>{% highlight javascript %}
/<em>
</em><em> Name: DPLII Quadrophonic Encoder
</em><em> Auth: Derek J. Evans (<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#100;&#101;&#114;&#101;&#107;&#46;&#106;&#111;&#104;&#110;&#46;&#101;&#118;&#97;&#110;&#115;&#64;&#104;&#111;&#116;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#100;&#101;&#114;&#101;&#107;&#46;&#106;&#111;&#104;&#110;&#46;&#101;&#118;&#97;&#110;&#115;&#64;&#104;&#111;&#116;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a>)
</em><em>
</em><em> Desc: Encodes a quadrophonic (4 channel) mix to a DPL/DPLII style stereo signal.
</em><em>       To use, place this effect after a ReaSurround (set to quadrophonic). This encoder
</em><em>       will take 4 channels (1-4) and output a stereo DPL/DPLII mix.
</em><em>       I have tested this encoder on a Kenwood Surround Receiver (KRF-V5560D) which has a licensed
</em><em>       Dolby Prologic II, DTS. <br />
</em><em> Note: The phase adjust was taken from "JS: Utility/phase_adjust". Great Code!
</em><em> Date: Monday, 13 January 2014
</em>/</p>
<p>desc: DPLII Quadrophonic Encoder</p>
<p>@init </p>
<p>fftsize = 8192; 
  pdc_bot_ch = 0;
  pdc_top_ch = 2;
  pdc_delay = fftsize;</p>
<p>// Array Pointers
  wind = 0;
  buf0 = fftsize * 2; // Rear
  buf1 = buf0 + buf0; 
  buf2 = buf1 + buf0; // Front
  buf3 = buf2 + buf0; </p>
<p>pos = 0; 
  w = 2.0 * $pi / fftsize;
  i = 0;
  loop(fftsize / 2,
    wind[i] = 0.42 - 0.50 * cos(i * w) + 0.08 * cos(2.0 * i *w);
    i += 1;
  ); 
  phaseadj = $pi * 90.0 / 180.0;
  cadj = cos(phaseadj);
  sadj = sin(phaseadj);</p>
<p>db0 = sqrt( 1 /  2);
  db1 = sqrt(19 / 25);
  db2 = sqrt( 6 / 25);</p>
<p>@sample</p>
<p>pos &gt;= fftsize ? (
    tmp = buf0; buf0 = buf1; buf1 = tmp;
    tmp = buf2; buf2 = buf3; buf3 = tmp;</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>fft(buf0, fftsize); 
fft_permute(buf0, fftsize);

i = 0;
loop(fftsize / 2, 
  a = i;
  b = a + 1;
  x = buf0[a];
  y = buf0[b];
  buf0[a] = x * cadj - y * sadj;
  buf0[b] = x * sadj + y * cadj;

  a = 2 * fftsize - i - 2;
  b = a + 1;
  x = buf0[a];
  y = buf0[b];
  buf0[a] =  x * cadj + y * sadj;
  buf0[b] = -x * sadj + y * cadj;

  i += 2;
);

fft_ipermute(buf0, fftsize); 
ifft(buf0, fftsize);

pos = 0;
</code></pre></div>
</td></tr></table>
<p>);</p>
<p>w1 = wind[pos / 2];
  w2 = wind[(fftsize - pos) / 2 - 1];
  sw = (w1 + w2) * fftsize;</p>
<p>FL = buf2[pos + 0]; // Front Left
  FR = buf2[pos + 1]; // Front Right
  RL = (buf0[pos + 0] + buf1[pos + 0 + fftsize]) / sw; // Rear Left
  RR = (buf0[pos + 1] + buf1[pos + 1 + fftsize]) / sw; // Read Right</p>
<p>buf2[pos + 0] = spl0; // Front Left
  buf2[pos + 1] = spl1; // Front Right</p>
<p>buf0[pos + 0] = spl2 * w1;
  buf0[pos + 1] = spl3 * w1;
  buf1[pos + 0 + fftsize] = spl2 * w2;
  buf1[pos + 1 + fftsize] = spl3 * w2;</p>
<p>// Dolby Pro Logic II Encoding Matrix    <br />
  spl0 = FL - RL * db1 - RR * db2; // Left Total
  spl1 = FR + RL * db2 + RR * db1; // Right Total</p>
<p>pos += 2;
{% endhighlight %}</p>
<p>Now to convert it to Go and slot it in somehow...</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../../../../about/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                About
              </div>
            </div>
          </a>
        
        
          <a href="../../31/panning-calculations/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Panning Calculations (01/31/20)
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../../assets/javascripts/vendor.53cc9318.min.js"></script>
      <script src="../../../../../assets/javascripts/bundle.e9c9f54f.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../../../../..",
          features: [],
          search: Object.assign({
            worker: "../../../../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>